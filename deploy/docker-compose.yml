services:
  etcd:
    image: quay.io/coreos/etcd:v3.5.15
    command:
      - /usr/local/bin/etcd
      - --name=etcd0
      - --data-dir=/etcd-data
      - --advertise-client-urls=http://etcd:2379
      - --listen-client-urls=http://0.0.0.0:2379
      - --initial-advertise-peer-urls=http://etcd:2380
      - --listen-peer-urls=http://0.0.0.0:2380
      - --initial-cluster=etcd0=http://etcd:2380
      - --initial-cluster-state=new
      - --logger=zap
      - --log-level=warn
    ports:
      - "2379:2379"
      - "2380:2380"
    volumes:
      - etcd-data:/etcd-data
    healthcheck:
      test: ["CMD", "etcdctl", "--endpoints=http://127.0.0.1:2379", "endpoint", "health"]
      interval: 10s
      timeout: 5s
      retries: 3

  node:
    build:
      context: ..
      dockerfile: Dockerfile
    environment:
      - ETCD_ENDPOINTS=http://etcd:2379
      - CLUSTER=dev
      # SELF_ID and SELF_ADDR will be set by entrypoint.sh
    depends_on:
      etcd:
        condition: service_healthy
    ports:
      - "8080-8179:8080"  # 100 ports for scaling to 100 nodes
    # Optional: Add resource limits to prevent one node from consuming everything
    deploy:
      resources:
        limits:
          cpus: '0.5'      # Max 0.5 CPU per node
          memory: 256M     # Max 256MB per node
        reservations:
          cpus: '0.1'
          memory: 64M
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8080/healthz >/dev/null 2>&1 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3

volumes:
  etcd-data:
